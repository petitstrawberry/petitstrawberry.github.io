<!doctype html><html lang=en-us dir=ltr><head><meta name=theme-color media="(prefers-color-scheme: light)" content="white"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="音楽再生環境を何とかしたい！ ここ数日、家での音楽再生環境の再構築をやってました。結果として良い環境が仕上がったと思います。せっかくなのでその経緯をここに記します。 今までの構成 # iMac MinimServer (音楽配信DLNAサ"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Raspberry PiとMediaPlayerを使ってOpenHomeレンダラを作る (前編)"><meta property="og:description" content="音楽再生環境を何とかしたい！ ここ数日、家での音楽再生環境の再構築をやってました。結果として良い環境が仕上がったと思います。せっかくなのでその経緯をここに記します。 今までの構成 # iMac MinimServer (音楽配信DLNAサ"><meta property="og:type" content="article"><meta property="og:url" content="https://ichigo.dev/posts/2022-06-16/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-16T11:00:56+09:00"><meta property="article:modified_time" content="2022-06-17T08:45:13+09:00"><title>Raspberry PiとMediaPlayerを使ってOpenHomeレンダラを作る (前編) | Ichigo Notes</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.f8de3645fe00591b41524aee174e19edd98a22255a2930a0cdc82a94835ba387.css integrity="sha256-+N42Rf4AWRtBUkruF04Z7dmKIiVaKTCgzcgqlINbo4c=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.8af8479f782936292b7568b5dbc7c529bae3ebdad85583b4819a8c103e808341.js integrity="sha256-ivhHn3gpNikrdWi128fFKbrj69rYVYO0gZqMED6Ag0E=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-2KMNJ1P766"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2KMNJ1P766")</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Ichigo Notes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><strong><a href=/docs>Documents</a></strong></ul><ul><li><a href=/docs/for_myself/>個人用</a><ul><li><a href=/docs/for_myself/network/>おもちの構成</a></li></ul></li><li><a href=/docs/smilebasic/>SmileBASIC</a><ul><li><a href=/docs/smilebasic/sws/>Sprite Window System</a><ul><li><input type=checkbox id=section-87e12f0017579970e2de9d51fdc15958 class=toggle>
<label for=section-87e12f0017579970e2de9d51fdc15958 class="flex justify-between"><a href=/docs/smilebasic/sws/uikit/>UIKit v0.1</a></label><ul><li><a href=/docs/smilebasic/sws/uikit/views/>Views</a><ul><li><input type=checkbox id=section-5f47e37b57f4c8e7c57bbecec0541fc8 class=toggle>
<label for=section-5f47e37b57f4c8e7c57bbecec0541fc8 class="flex justify-between"><a role=button>Fundamental Views</a></label><ul><li><a href=/docs/smilebasic/sws/uikit/views/fundamental/view/>View</a></li><li><a href=/docs/smilebasic/sws/uikit/views/fundamental/wrapper/>Wrapper</a></li><li><a href=/docs/smilebasic/sws/uikit/views/fundamental/spacer/>Spacer</a></li></ul></li><li><input type=checkbox id=section-797b7d77f7141167f2f3ee8489074a9b class=toggle>
<label for=section-797b7d77f7141167f2f3ee8489074a9b class="flex justify-between"><a href=/docs/smilebasic/sws/uikit/views/layouts/>Layout Containers</a></label><ul><li><a href=/docs/smilebasic/sws/uikit/views/layouts/vstack/>VStack</a></li><li><a href=/docs/smilebasic/sws/uikit/views/layouts/hstack/>HStack</a></li><li><a href=/docs/smilebasic/sws/uikit/views/layouts/zstack/>ZStack</a></li></ul></li><li><input type=checkbox id=section-702430f3e53b241eca2e05fad93243ff class=toggle>
<label for=section-702430f3e53b241eca2e05fad93243ff class="flex justify-between"><a role=button>Navigation Containers</a></label><ul><li><a href=/docs/smilebasic/sws/uikit/views/navigations/navigationview/>NavigationView</a></li><li><a href=/docs/smilebasic/sws/uikit/views/navigations/navigationlink/>NavigationLink</a></li></ul></li><li><input type=checkbox id=section-64fb519ebdb215d8db91cf4da8f17c22 class=toggle>
<label for=section-64fb519ebdb215d8db91cf4da8f17c22 class="flex justify-between"><a role=button>Text and Inputs</a></label><ul><li><a href=/docs/smilebasic/sws/uikit/views/text_input/text/>Text</a></li></ul></li><li><input type=checkbox id=section-a130191f72f9865bbabe6852310c53db class=toggle>
<label for=section-a130191f72f9865bbabe6852310c53db class="flex justify-between"><a role=button>Controls</a></label><ul><li><a href=/docs/smilebasic/sws/uikit/views/controls/ubutton/>uButton</a></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul><br><ul><li><strong>Contents</strong></li><li><a href=/posts>なんかやってるシリーズ</a></li><li><a href=/privacy>プライバシーポリシー</a></li></ul><br><ul><li><strong>Links</strong></li><li><a href=https://github.com/petitstrawberry>GitHub</a></li><li><a href=https://twitter.com/petitstb>Twitter</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#今までの構成>今までの構成</a></li><li><a href=#なんか微妙な感じがするます>なんか微妙な感じがするます</a><ul><li><a href=#そもそも音楽再生用ディストリビューションって>そもそも音楽再生用ディストリビューションって</a></li><li><a href=#何が辛いのか>何が辛いのか</a></li></ul></li><li><a href=#良さげなmediaplayerの発見>良さげなMediaPlayerの発見</a></li></ul></nav></aside></header><article class=markdown><h1>Raspberry PiとMediaPlayerを使ってOpenHomeレンダラを作る (前編)</h1><h5>June 16, 2022</h5><div><a href=/tags/raspberry-pi/>Raspberry Pi</a>,
<a href=/tags/%E3%82%AA%E3%83%BC%E3%83%87%E3%82%A3%E3%82%AA/>オーディオ</a>,
<a href=/tags/openhome/>OpenHome</a>,
<a href=/tags/mediaplayer/>MediaPlayer</a>,
<a href=/tags/mpd/>MPD</a></div><p><em><strong>音楽再生環境を何とかしたい！</strong></em></p><p>ここ数日、家での音楽再生環境の再構築をやってました。結果として良い環境が仕上がったと思います。せっかくなのでその経緯をここに記します。</p><h2 id=今までの構成>今までの構成
<a class=anchor href=#%e4%bb%8a%e3%81%be%e3%81%a7%e3%81%ae%e6%a7%8b%e6%88%90>#</a></h2><ul><li>iMac<ul><li>MinimServer (音楽配信DLNAサーバ)</li></ul></li><li>Raspberry Pi 4 model B<ul><li>HiFiBerry DAC2 PRO (D/A)<ul><li>ここからライン出力してアンプに渡す</li></ul></li><li>moOde audio<ul><li>mpdをWeb UIから良い感じに使えるディストリビューション</li><li>upmpdcli<ul><li>mpdをDLNA/OpenHomeレンダラとしても使えるようにする(moOdeからはオプションとして有効にできる)</li></ul></li></ul></li></ul></li><li>MacBook/iOSデバイス/Androidデバイス<ul><li>Lumin AppやBubbleUPnPなどをOpenHomeコントローラとして使う</li></ul></li></ul><p>というような構成でした。基本的にはMPDクライアントを用いる使い方はせず、WebUIも使わず、単にOpenHomeレンダラとして使っていました。</p><h2 id=なんか微妙な感じがするます>なんか微妙な感じがするます
<a class=anchor href=#%e3%81%aa%e3%82%93%e3%81%8b%e5%be%ae%e5%a6%99%e3%81%aa%e6%84%9f%e3%81%98%e3%81%8c%e3%81%99%e3%82%8b%e3%81%be%e3%81%99>#</a></h2><h3 id=そもそも音楽再生用ディストリビューションって>そもそも音楽再生用ディストリビューションって
<a class=anchor href=#%e3%81%9d%e3%82%82%e3%81%9d%e3%82%82%e9%9f%b3%e6%a5%bd%e5%86%8d%e7%94%9f%e7%94%a8%e3%83%87%e3%82%a3%e3%82%b9%e3%83%88%e3%83%aa%e3%83%93%e3%83%a5%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%a3%e3%81%a6>#</a></h3><p>結局のところVolumioやmoOde audioといったものはmpdの各機能をWebUIから簡単に設定できるようにしているだけのものです。初心者でも難しいことをせずに、SDカードにイメージ焼いて、WebUIから設定すれば簡単に高機能なプレイヤーを構築できて良い感じです。</p><p>他に機能面で言うと、mpdの他に様々なソフトウェアを組み合わせることでupmpdcliでDLNA/OpenHomeレンダラとして使ったり、shairport-syncを使ってAirPlayレシーバにしたりできます。</p><p>あくまでそのディストリが用意したものだけで完結させることを想定している感じです。
それ故にいくつか辛いことがあります。</p><h3 id=何が辛いのか>何が辛いのか
<a class=anchor href=#%e4%bd%95%e3%81%8c%e8%be%9b%e3%81%84%e3%81%ae%e3%81%8b>#</a></h3><p>たとえば、</p><ul><li>WebUIの項目にないmpdの設定を変更しようと思って/etc/mpd.confを編集しても、起動時にmoOde側のテンプレートを基に動的生成された設定ファイルによって上書きされる。<ul><li>編集したい場合は/etc/mpd.confではなくmoOde側が用意したテンプレートを編集する必要がある。</li></ul></li><li>moOde側の設定ファイルのテンプレートなどを変更しても、moOdeの更新により上書きされる。</li><li>moOdeのシステムとの連携の都合があるので、moOdeのソフトウェアアップデート機能ではなくapt-get upgradeして各ソフトウェアを更新するなどしてソフトウェアを変更したような場合、起動しなくなることがある。</li><li>同様の理由で一部のソフトウェアを自分で改変してビルドして使うようにすることも困難。</li></ul><p>といった辛いポイントがある。辛い。</p><p>このようにmoOde側が用意した項目以外に変更を加えるような使い方には向いていないことがわかります。</p><p>さらに、VolumioやmoOdeはDLNA/OpenHomeレンダラやAirPlayレシーバとして使うよりも、「Raspberry Pi自体をmpdによって音楽プレイヤーにしよう」という考え方で作られたディストリビューションであるので、mpdはバックエンドにあればよくて、いい感じの選曲用WebUIとか必要なく、「OpenHomeレンダラとして使いたいだけなんだ！」という僕みたいな人には向いてません。</p><p>そしてOpenHome/DLNAレンダラ化する際にはupmpdcliにお世話になるので、ここに不満点があると辛いことになります。もちろんmpd自体に不満点があっても辛いことになります。</p><p><em><strong>辛いことになった</strong></em></p><blockquote class="book-hint warning">ここからはVolumioやmoOdeの問題というより、僕にどのような事情があってmoOdeに手を入れたくなり、辛いことになったかという個人的な問題の話題になります。読み飛ばしてもらっても問題ありません。</blockquote><details><summary>個人的に辛かったこと</summary><div class=markdown-inner><p>mpdをOpenHomeレンダラ(DMR)として動作させるため、upmpdcliはLumin Appなどのコントローラ(DMC)とmpdの間をmpdのクライアントとなって中継して、再生する曲のURLや再生制御をmpdに指示したり、再生位置や音量などの情報をDMCに渡したりします。
そうして受けた再生指示で、URLから曲を再生します。</p><p>ここで辛いことになった。</p><p>このように渡されたURLから音楽を再生すると、mpdではアーティスト名が奇妙なことになります。</p><p>再生中の曲情報を表示してみると</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ mpc -f <span style=color:#e6db74>&#34;%artist%&#34;</span>
</span></span><span style=display:flex><span>北宇治高校吹奏楽部, 松田彬人<span style=color:#f92672>(</span>composer<span style=color:#f92672>)</span>, kensuke ushio
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>paused<span style=color:#f92672>]</span>  <span style=color:#75715e>#1/1   0:01/6:25 (0%)</span>
</span></span><span style=display:flex><span>volume: 50%   repeat: off   random: off   single: off   consume: on 
</span></span></code></pre></div><p>のように、artist, composer, album_artistがまとめてartistとして扱われてしまいました。単に音楽を再生するだけであれば大して問題にもなりません。
しかし、僕はmpdで再生している曲の情報を取得してlast.fmにscrobbleするmpdasというソフトウェアを使おうと考えていました。つまりこのままmpdasを使うとアーティスト名に余計な情報を含めたままlast.fmにscrobbleしてしまうのです。(mpdasはmpd向けのソフトウェア)</p><p>ここで、これをなんとか解決しようと考えました。まず、Lumin Appから再生中の曲のアーティスト名がどのように表示されているのかを確認しました。ここでは問題はありませんでした。つまり、OpenHomeのレイヤーでは問題はないということです。upmpdcliとmpdのどちらかかその両方に問題があるということになります。そして、その原因を調べて修正しようと考えました。</p><p>しかし、ここで力尽きました。先に述べたようにmoOdeの環境で各ソフトウェアを改変するのは辛いです。</p></div></details><p>結局、OpenHomeでしか使わないのにmpdのレイヤーで色々と試行錯誤するのは微妙な感じがした(正直upmpdcliがよくわからんかった)ので、もういっそのことmoOdeを使うことをやめ、OpenHomeレンダラとして使うことに重きを置いた環境を構築しようと考えました。</p><h2 id=良さげなmediaplayerの発見>良さげなMediaPlayerの発見
<a class=anchor href=#%e8%89%af%e3%81%95%e3%81%92%e3%81%aamediaplayer%e3%81%ae%e7%99%ba%e8%a6%8b>#</a></h2><p>そして色々と漁っていたところ<a href=https://github.com/PeteManchester/MediaPlayer>MediaPlayer</a>というソフトウェアを発見しました。これは"MediaPlayer - Java Based Open Home UPnP Media Renderer"ということでどうやらこれが求めていたものに近そうです。ディストリビューションではないので、Raspberry Pi OS(旧raspbian)などの上に追加でインストールしていきます。</p><p>このMediaPlayerは音楽の再生部にmpdかmplayerのどちらかを選んでOpenHomeレンダラとして扱えるようにするようです。さらにプラグインにも対応しており、OpenHomeのレイヤーで情報を取得することができそうです。(この中にはlast.fmのscrobblerもありました。)</p><p>せっかくmplayerというmpd以外の選択肢もあるのですが、mpdの方が細かい設定が出来そう(今までの知見が活かせる)ので結局mpdをバックエンドに使うことになりました。(mpd使うならあんまり変わってないじゃないか！とは思いますが)<br>ただ、moOdeやVolumioというように単独の音楽プレイヤー化を目指したものではなく、余計なもの(OpenHomeレンダラに必要ないもの)が含まれていないので扱いやすそうです。これまでダラダラと書いてきましたが、結局<strong>mpdのフロントエンドをOpenHomeレンダラとして使うことに特化したものに置き換えるというだけの話になります。</strong></p><p>という訳で、MediaPlayerを採用することにしました。ここからの環境構築のお話は後編に続きます。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/petitstrawberry/blog/commit/a91bf84437458294cc7f01a1c9f3700e775fff45 title='Last modified by プチいちご | June 16, 2022' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 16, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/petitstrawberry/blog/edit/master/content/posts/2022-06-16/index.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#今までの構成>今までの構成</a></li><li><a href=#なんか微妙な感じがするます>なんか微妙な感じがするます</a><ul><li><a href=#そもそも音楽再生用ディストリビューションって>そもそも音楽再生用ディストリビューションって</a></li><li><a href=#何が辛いのか>何が辛いのか</a></li></ul></li><li><a href=#良さげなmediaplayerの発見>良さげなMediaPlayerの発見</a></li></ul></nav></div></aside></main></body></html>